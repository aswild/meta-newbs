From 183d02325fdf5f048b2e21def4e1ec46676baa1c Mon Sep 17 00:00:00 2001
From: Allen Wild <allenwild93@gmail.com>
Date: Fri, 10 Mar 2017 00:57:42 -0500
Subject: [PATCH 07/15] shiftbrite: add hello ioctl

---
 drivers/misc/shiftbrite.c      | 27 ++++++++++++++++++++++++---
 include/uapi/misc/Kbuild       |  1 +
 include/uapi/misc/shiftbrite.h | 23 +++++++++++++++++++++++
 3 files changed, 48 insertions(+), 3 deletions(-)
 create mode 100644 include/uapi/misc/shiftbrite.h

diff --git a/drivers/misc/shiftbrite.c b/drivers/misc/shiftbrite.c
index 600c8d8..6f6e883 100644
--- a/drivers/misc/shiftbrite.c
+++ b/drivers/misc/shiftbrite.c
@@ -18,13 +18,16 @@
 #include <linux/cdev.h>
 #include <linux/delay.h>
 #include <linux/fs.h>
+#include <linux/ioctl.h>
 #include <linux/module.h>
-#include <linux/spinlock.h>
 #include <linux/of_device.h>
 #include <linux/of_gpio.h>
+#include <linux/spinlock.h>
 #include <linux/spi/spi.h>
 #include <asm/uaccess.h>
 
+#include <uapi/misc/shiftbrite.h>
+
 #define RED24(value)    ((value & 0x00FF0000) >> 16)
 #define GREEN24(value)  ((value & 0x0000FF00) >> 8)
 #define BLUE24(value)    (value & 0x000000FF)
@@ -267,9 +270,27 @@ static ssize_t shiftbrite_cdev_write(struct file *filep, const char *buf, size_t
     return size;
 }
 
+long shiftbrite_cdev_ioctl(struct file *filep, unsigned int cmd, unsigned long arg)
+{
+    long ret = 0;
+
+    switch (cmd)
+    {
+        case SHIFTBRITE_IOCQHELLO:
+            pr_info("shiftbrite: ioctl hello with arg 0x%lX\n", arg);
+            break;
+        default:
+            pr_err("shiftbrite: unknown ioctl\n");
+            ret = -ENOTTY;
+            break;
+    }
+    return ret;
+}
+
 static struct file_operations shiftbrite_cdev_fops = {
-    .read = shiftbrite_cdev_read,
-    .write = shiftbrite_cdev_write,
+    .read           = shiftbrite_cdev_read,
+    .write          = shiftbrite_cdev_write,
+    .unlocked_ioctl = shiftbrite_cdev_ioctl,
 };
 
 // Init/Exit Functions
diff --git a/include/uapi/misc/Kbuild b/include/uapi/misc/Kbuild
index e96cae7..99beb11 100644
--- a/include/uapi/misc/Kbuild
+++ b/include/uapi/misc/Kbuild
@@ -1,2 +1,3 @@
 # misc Header export list
 header-y += cxl.h
+header-y += shiftbrite.h
diff --git a/include/uapi/misc/shiftbrite.h b/include/uapi/misc/shiftbrite.h
new file mode 100644
index 0000000..d309f73
--- /dev/null
+++ b/include/uapi/misc/shiftbrite.h
@@ -0,0 +1,23 @@
+/***********************************************************************
+ * Shiftbrite SPI RGB LED Driver
+ *
+ * Copyright (C) 2017 Allen Wild <allenwild93@gmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation, version 2.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ ***********************************************************************/
+
+#ifndef _SHIFTBRITE_H_
+#define _SHIFTBRITE_H_
+
+#include <linux/ioctl.h>
+
+#define SHIFTBRITE_IOCQHELLO    _IO('S', 1)
+
+#endif // _SHIFTBRITE_H_
-- 
2.9.3

