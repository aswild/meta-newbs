From 9e13a38136ac76bc9ae788a974f26c9a3d2e78b2 Mon Sep 17 00:00:00 2001
From: Allen Wild <allenwild93@gmail.com>
Date: Tue, 14 Mar 2017 00:59:40 -0400
Subject: [PATCH 12/17] shiftbrite: rename overlay to spi0-shiftbrite.dtbo, add
 spi1 overlay

spi1 might not work though
---
 arch/arm/boot/dts/overlays/Makefile                |  3 +-
 ...ite-overlay.dts => spi0-shiftbrite-overlay.dts} |  0
 .../boot/dts/overlays/spi1-shiftbrite-overlay.dts  | 63 ++++++++++++++++++++++
 3 files changed, 65 insertions(+), 1 deletion(-)
 rename arch/arm/boot/dts/overlays/{pi3-spi-shiftbrite-overlay.dts => spi0-shiftbrite-overlay.dts} (100%)
 create mode 100644 arch/arm/boot/dts/overlays/spi1-shiftbrite-overlay.dts

diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
index cf0dbcfe50cb..56b08dc2cc61 100644
--- a/arch/arm/boot/dts/overlays/Makefile
+++ b/arch/arm/boot/dts/overlays/Makefile
@@ -59,7 +59,6 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
 	pi3-disable-bt.dtbo \
 	pi3-disable-wifi.dtbo \
 	pi3-miniuart-bt.dtbo \
-	pi3-spi-shiftbrite.dtbo \
 	piscreen.dtbo \
 	piscreen2r.dtbo \
 	pisound.dtbo \
@@ -93,9 +92,11 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
 	spi-rtc.dtbo \
 	spi0-cs.dtbo \
 	spi0-hw-cs.dtbo \
+	spi0-shiftbrite.dtbo \
 	spi1-1cs.dtbo \
 	spi1-2cs.dtbo \
 	spi1-3cs.dtbo \
+	spi1-shiftbrite.dtbo \
 	spi2-1cs.dtbo \
 	spi2-2cs.dtbo \
 	spi2-3cs.dtbo \
diff --git a/arch/arm/boot/dts/overlays/pi3-spi-shiftbrite-overlay.dts b/arch/arm/boot/dts/overlays/spi0-shiftbrite-overlay.dts
similarity index 100%
rename from arch/arm/boot/dts/overlays/pi3-spi-shiftbrite-overlay.dts
rename to arch/arm/boot/dts/overlays/spi0-shiftbrite-overlay.dts
diff --git a/arch/arm/boot/dts/overlays/spi1-shiftbrite-overlay.dts b/arch/arm/boot/dts/overlays/spi1-shiftbrite-overlay.dts
new file mode 100644
index 000000000000..b22f6de69a95
--- /dev/null
+++ b/arch/arm/boot/dts/overlays/spi1-shiftbrite-overlay.dts
@@ -0,0 +1,63 @@
+/*
+ * Device Tree overlay for the Shiftbrite module
+ *
+ */
+
+/dts-v1/;
+/plugin/;
+
+/ {
+    compatible = "brcm,bcm2835", "brcm,bcm2708", "brcm,bcm2709";
+
+    fragment@0 {
+        target = <&gpio>;
+        __overlay__ {
+            spi1_pins: spi1_pins {
+                /*
+                 * shiftbrite needs 3 pins - latch, data, clock
+                 * Can't use SPI chip-select because it will toggle in the
+                 * middle of transfers, so use a separate GPIO for latch.
+                 *
+                 * Because shiftbrite doesn't respond to a chip-select, it doesn't
+                 * make sense to have other devices on the same SPI bus, therefore
+                 * we can re-purpose the SPI MISO pin (9) as the latch output GPIO
+                 */
+                brcm,pins = <9 10 11>;
+                brcm,function = <1 4 4>; /* output (latch), alt0 (spi) */
+            };
+        };
+    };
+
+    fragment@1 {
+        target = <&spi1>;
+        __overlay__ {
+            #address-cells = <1>;
+            #size-cells = <0>;
+
+            status = "okay";
+            pinctrl-names = "default";
+            pinctrl-0 = <&spi1_pins>;
+
+            /* disable spi-dev for spi1.0 & spi1.1 */
+            spidev@0 {
+                status = "disabled";
+            };
+            spidev@1 {
+                status = "disabled";
+            };
+
+            shiftbrite0: shiftbrite@0 {
+                compatible = "shiftbrite";
+                reg = <0>;      /* CE0 */
+                spi-max-frequency = <500000>;
+                latch-gpio = <9>;
+                status = "okay";
+            };
+        };
+    };
+
+    __overrides__ {
+        shiftbrite0_latch = <&spi1_pins>,"brcm,pins:0",
+                            <&shiftbrite0>,"latch-gpio:0";
+    };
+};
-- 
2.12.0

