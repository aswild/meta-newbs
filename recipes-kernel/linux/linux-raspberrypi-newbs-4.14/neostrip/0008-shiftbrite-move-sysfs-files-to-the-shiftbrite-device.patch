From bd5918b4d06dcf755612894bda69d8dfe002717b Mon Sep 17 00:00:00 2001
From: Allen Wild <allenwild93@gmail.com>
Date: Sat, 11 Mar 2017 15:39:09 -0500
Subject: [PATCH 08/19] shiftbrite: move sysfs files to the shiftbrite device
 instead of spi device

---
 drivers/spi/shiftbrite.c | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/drivers/spi/shiftbrite.c b/drivers/spi/shiftbrite.c
index bdcf7773e0cf..73de5525f244 100644
--- a/drivers/spi/shiftbrite.c
+++ b/drivers/spi/shiftbrite.c
@@ -61,6 +61,7 @@
 
 struct shiftbrite_chip {
     dev_t               devt;
+    struct device       *dev;
     struct spi_device   *spi;
     struct list_head    device_entry;
 
@@ -397,8 +398,8 @@ static int shiftbrite_probe(struct spi_device *spi)
 
     // create device node
     chip->devt = MKDEV(shiftbrite_major, minor);
-    dev = device_create(shiftbrite_class, &spi->dev, chip->devt, chip, "shiftbrite%lu", minor);
-    if (IS_ERR(dev))
+    chip->dev = device_create(shiftbrite_class, &spi->dev, chip->devt, chip, "shiftbrite%lu", minor);
+    if (IS_ERR(chip->dev))
     {
         dev_err(&spi->dev, "device_create() failed\n");
         ret = PTR_ERR_OR_ZERO(dev);
@@ -415,7 +416,7 @@ static int shiftbrite_probe(struct spi_device *spi)
     // create sysfs files
     for (sysfs_i = 0; sysfs_i < sizeof(shiftbrite_sysfs_attrs)/sizeof(shiftbrite_sysfs_attrs[0]); sysfs_i++)
     {
-        ret = device_create_file(&spi->dev, shiftbrite_sysfs_attrs[sysfs_i]);
+        ret = device_create_file(chip->dev, shiftbrite_sysfs_attrs[sysfs_i]);
         if (ret)
         {
             dev_err(&spi->dev, "Failed to create sysfs file %s\n", shiftbrite_sysfs_attrs[sysfs_i]->attr.name);
@@ -442,7 +443,7 @@ static int shiftbrite_probe(struct spi_device *spi)
 
 fail_destroy_sysfs:
     for (sysfs_i--; sysfs_i >= 0; sysfs_i--)
-        device_remove_file(&spi->dev, shiftbrite_sysfs_attrs[sysfs_i]);
+        device_remove_file(chip->dev, shiftbrite_sysfs_attrs[sysfs_i]);
 
 //fail_device_destroy:
     mutex_lock(&device_list_lock);
@@ -466,7 +467,7 @@ static int shiftbrite_remove(struct spi_device *spi)
     int i;
 
     for (i = 0; i < sizeof(shiftbrite_sysfs_attrs)/sizeof(shiftbrite_sysfs_attrs[0]); i++)
-        device_remove_file(&spi->dev, shiftbrite_sysfs_attrs[i]);
+        device_remove_file(chip->dev, shiftbrite_sysfs_attrs[i]);
 
     spin_lock_irq(&chip->lock);
     chip->spi = NULL;
-- 
2.17.0

